include_rules
# =====================================

BUILD_DIR = target

SNAPPY_DIR = deps/snappy-1.1.0
SNAPPY_LIB = $(SNAPPY_DIR)/.libs/libsnappy.a

HYPERLEVELDB_DIR = deps/HyperLevelDB
HYPERLEVELDB_LIB = target/libhyperleveldb.a

# hyperleveldb

HYPERLEVELDB_FLAGS += $(CXXFLAGS)
HYPERLEVELDB_FLAGS += -DHAVE_CONFIG_H -DLEVELDB_PLATFORM_POSIX -DOS_LINUX -DSNAPPY
HYPERLEVELDB_FLAGS += -fno-builtin-memcmp -Wno-sign-compare -Wno-unused-but-set-variable -Wno-variadic-macros
HYPERLEVELDB_FLAGS += -I$(HYPERLEVELDB_DIR)/include -I$(HYPERLEVELDB_DIR) -I$(SNAPPY_DIR)

# linux/posix
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/port/port_posix.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/env_posix.cc

# hyperleveldb specific
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/replay_iterator.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/atomic.cc

#HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/dumpfile.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/c.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/builder.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/db_impl.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/db_iter.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/filename.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/dbformat.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/log_reader.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/log_writer.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/memtable.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/repair.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/table_cache.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/version_edit.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/version_set.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/db/write_batch.cc
#HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/helpers/memenv/memenv.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/block.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/block_builder.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/filter_block.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/format.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/iterator.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/merger.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/table.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/table_builder.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/table/two_level_iterator.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/arena.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/bloom.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/cache.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/coding.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/comparator.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/crc32c.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/env.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/filter_policy.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/hash.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/logging.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/options.cc
HYPERLEVELDB_SRCS += $(HYPERLEVELDB_DIR)/util/status.cc

: foreach $(HYPERLEVELDB_SRCS) |> $(CXX) -c $(HYPERLEVELDB_FLAGS) %f -o %o |> $(BUILD_DIR)/hyperleveldb/%B.o
: $(BUILD_DIR)/hyperleveldb/*.o |> !ar |> $(HYPERLEVELDB_LIB)

# =====================================

JEMALLOC_DIR = deps/jemalloc-4.1.0
JEMALLOC_LIB = $(JEMALLOC_DIR)/lib/libjemalloc.a

LEVELDB_DIR = deps/leveldb-1.18
LEVELDB_LIB = $(LEVELDB_DIR)/libleveldb.a

#CXXFLAGS += -I$(LEVELDB_DIR)/include -I$(JEMALLOC_DIR)/include
#LINK_LIBS = $(LEVELDB_LIB) $(SNAPPY_LIB) $(JEMALLOC_LIB)
CXXFLAGS += -I$(HYPERLEVELDB_DIR)/include -I$(JEMALLOC_DIR)/include
LINK_LIBS = $(HYPERLEVELDB_LIB) $(SNAPPY_LIB) $(JEMALLOC_LIB)
LINK_FLAGS = -pthread -lrt

# util
LIBUTIL = target/libutil.a
#: foreach src/util/*.cpp |> !cxx |> target/util/%B.o
: src/util/app.cpp |> !cxx |> target/util/%B.o
: src/util/log.cpp |> !cxx |> target/util/%B.o
: src/util/config.cpp |> !cxx |> target/util/%B.o
: src/util/bytes.cpp |> !cxx |> target/util/%B.o
: src/util/sorted_set.cpp |> !cxx |> target/util/%B.o

: target/util/*.o |> !ar |> $(LIBUTIL)

# net
LIBNET = target/libnet.a
#: foreach src/net/*.cpp |> !cxx |> target/net/%B.o
: src/net/fde.cpp |> !cxx |> target/net/%B.o
: src/net/link.cpp |> !cxx |> target/net/%B.o
: src/net/resp.cpp |> !cxx |> target/net/%B.o
: src/net/proc.cpp |> !cxx |> target/net/%B.o
: src/net/worker.cpp |> !cxx |> target/net/%B.o
: src/net/server.cpp |> !cxx |> target/net/%B.o

: target/net/*.o |> !ar |> $(LIBNET)

# ssdb
LIBSSDB = target/libssdb.a
#: foreach src/ssdb/*.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/ssdb_impl.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/iterator.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/options.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/t_kv.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/t_hash.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/t_zset.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/t_queue.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/binlog.cpp |> !cxx |> target/ssdb/%B.o
: src/ssdb/ttl.cpp |> !cxx |> target/ssdb/%B.o

: target/ssdb/*.o |> !ar |> $(LIBSSDB)

# client
LIBCLIENT = target/libclient.a
CXXFLAGS += -Isrc
: foreach src/client/*.cpp |> !cxx |> target/client/%B.o
: target/client/*.o |> !ar |> $(LIBCLIENT)

# src
#LIBSRC = target/libsrc.a
CXXFLAGS += -Isrc/client
: foreach src/*.cpp |> !cxx |> target/src/%B.o
#: target/src/*.o |> !ar |> $(LIBSRC)

SERVER_LIBS = $(LIBSSDB) $(LIBUTIL) $(LIBNET)
SERVER_OBJS += target/src/ssdb-server.o
SERVER_OBJS += target/src/proc_kv.o
SERVER_OBJS += target/src/proc_hash.o
SERVER_OBJS += target/src/proc_zset.o
SERVER_OBJS += target/src/proc_queue.o
SERVER_OBJS += target/src/backend_dump.o
SERVER_OBJS += target/src/backend_sync.o
SERVER_OBJS += target/src/slave.o
SERVER_OBJS += target/src/serv.o
SERVER_OBJS += target/src/proc_cluster.o
SERVER_OBJS += target/src/cluster.o
SERVER_OBJS += target/src/cluster_store.o
SERVER_OBJS += target/src/cluster_migrate.o
SERVER_OBJS += target/client/SSDB_impl.o

: $(SERVER_OBJS) $(SERVER_LIBS) |> $(CXX) -o %o $(OPT_FLAGS) %f $(LINK_LIBS) $(LINK_FLAGS) |> target/bin/ssdb-server
